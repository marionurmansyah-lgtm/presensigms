<!DOCTYPE html>
<html lang="id">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi GMS - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- UI PROFESSIONAL V2 --- */
    :root {
        --primary: #1e293b; 
        --primary-hover: #0f172a;
        --primary-light: #334155;
        --accent: #3b82f6; 
        --success: #10b981;
        --success-light: #d1fae5;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --warning: #f59e0b;
        
        --bg-app: #f1f5f9; 
        --bg-pattern: radial-gradient(#cbd5e1 1px, transparent 1px);
        --surface: #ffffff;
        
        --text-main: #0f172a;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        
        --border: #e2e8f0;
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
        background-color: var(--bg-app); 
        background-image: var(--bg-pattern);
        background-size: 20px 20px;
        color: var(--text-main); 
        font-family: 'Inter', sans-serif; 
        padding-bottom: 100px; 
        -webkit-font-smoothing: antialiased;
    }
    
    .hidden { display: none !important; }
    
    .container { max-width: 480px; margin: 0 auto; padding: 0 20px; width: 100%; }
    .container.admin { max-width: 1200px; }

    .card { 
        background: var(--surface); 
        border-radius: var(--radius-md); 
        padding: 24px; 
        box-shadow: var(--shadow-sm); 
        margin-bottom: 24px; 
        border: 1px solid var(--border); 
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    /* BUTTONS WITH SPINNER */
    .btn { 
        padding: 14px 24px; 
        border: none; 
        border-radius: 12px; 
        font-weight: 600; 
        font-size: 0.95rem; 
        letter-spacing: 0.025em; 
        cursor: pointer; 
        width: 100%; 
        transition: all 0.2s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.7; cursor: wait; }
    
    .btn-primary { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.25); 
    }
    
    .btn-success { 
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); 
    }
    
    .btn-danger { 
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); 
    }
    
    .btn-outline { 
        background: white; 
        border: 1px solid var(--border); 
        color: var(--text-main); 
        box-shadow: none; 
    }
    .btn-outline:hover { background: #f8fafc; }
    
    .btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; display: inline-flex; height: 36px; }
    .btn-print { background: var(--text-main); color: white; width: auto; box-shadow: none; }
    .btn-excel { background: #217346; color: white; width: auto; box-shadow: none; }

    /* SPINNER ANIMATION */
    .spinner {
        width: 16px; height: 16px;
        border: 2px solid #ffffff;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* INPUTS */
    input, select, textarea { 
        width: 100%; 
        padding: 14px 16px; 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        margin-bottom: 16px; 
        font-size: 0.95rem; 
        background: #fdfdfd;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
    }
    
    input:focus, select:focus, textarea:focus { 
        border-color: var(--accent); 
        outline: none; 
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
        background: #fff;
    }
    
    label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px; letter-spacing: 0.025em; }

    /* LOGIN */
    .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; }
    .login-card { 
        width: 100%; 
        max-width: 400px; 
        text-align: center; 
        background: white; 
        padding: 40px 30px; 
        border-radius: 32px; 
        box-shadow: var(--shadow-lg); 
        border: 1px solid var(--border);
    }
    .app-logo { 
        width: 80px; height: 80px; margin: 0 auto 24px; display: block; object-fit: contain; 
        border-radius: 20px; box-shadow: var(--shadow-md);
    }
    .login-footer { margin-top: 30px; text-align: center; color: var(--text-light); font-size: 0.85rem; }
    .brand-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 4px; color: var(--primary); }
    .support-text { font-weight: 500; }

    /* PROFILE & CLOCK */
    .profile-header { 
        background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%); 
        color: white; 
        padding: 50px 24px 80px; 
        border-radius: 0 0 40px 40px; 
        margin-top: -20px; 
        box-shadow: var(--shadow-md);
        position: relative;
    }
    .profile-content { display: flex; align-items: center; gap: 16px; }
    .profile-avatar-icon { 
        width: 60px; height: 60px; border-radius: 50%; 
        background: rgba(255,255,255,0.25); 
        display: flex; align-items: center; justify-content: center; 
        border: 2px solid rgba(255,255,255,0.6);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .clock-widget { 
        background: var(--glass-bg); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        margin-top: -50px; 
        margin-bottom: 30px; 
        padding: 24px; 
        border-radius: 24px; 
        text-align: center; 
        box-shadow: var(--shadow-lg); 
        position: relative; 
        z-index: 10;
        border: 1px solid var(--glass-border);
    }
    #date-display { font-size: 0.75rem; font-weight: 600; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1.5px; }
    #time-display { font-size: 3rem; font-weight: 800; color: var(--primary); line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -2px; }

    /* CLOCK BUTTONS */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 30px; }
    .clock-btn { height: 120px; flex-direction: column; font-size: 1.1rem; font-weight: 700; border-radius: 24px; border: none; }
    
    /* MARQUEE */
    .marquee-strip {
        background: #fffbeb; color: #92400e; padding: 14px 0; border-radius: 12px; margin: 16px 0;
        font-size: 0.9rem; font-weight: 600; overflow: hidden; white-space: nowrap;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #fcd34d;
    }
    .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
     
    /* ADMIN */
    .container.admin { max-width: 95%; margin: 30px auto; padding: 0; width: 100%; }

    /* TABS */
    .tab-btn { 
        background: white; border: 1px solid var(--border); color: var(--text-muted); 
        padding: 12px 28px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; 
        white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); border-color: var(--primary); }
    .tab-btn.active {
        background: var(--primary) !important; color: white !important; border-color: var(--primary) !important;
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.3); font-weight: 700; transform: translateY(-2px);
    }
    .tab-emp.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; border-color: #059669 !important; }
    .tab-att.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; border-color: #2563eb !important; }
    .tab-sub.active { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; border-color: #d97706 !important; }
    
    /* TABLES */
    .table-container { overflow-x: auto; background: white; border-radius: var(--radius-md); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f8fafc; text-align: left; padding: 16px 20px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
    tr:hover td { background: #fdfdfd; }

    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-success { background: var(--success-light); color: #065f46; }
    .badge-danger { background: var(--danger-light); color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    .admin-header { display: flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--border); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow-sm); }
    .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; line-height: 1; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; }

    .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .filter-bar input, .filter-bar select { width: auto; min-width: 140px; margin-bottom: 0; font-size: 0.85rem; padding: 8px 12px; }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-box { background: white; width: 95%; max-width: 500px; border-radius: 24px; padding: 32px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* TOAST */
    #toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast { background: white; padding: 16px 24px; border-radius: 12px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; min-width: 300px; border-left: 5px solid var(--primary); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; font-size: 0.9rem; font-weight: 500; }
    .toast.show { transform: translateX(0); }
    .toast.error { border-left-color: var(--danger); }

    video { width: 100%; height: 280px; background: black; border-radius: 20px; object-fit: cover; transform: scaleX(-1); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .input-group { display: flex; gap: 10px; }
    .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #f1f5f9; font-weight: 600; color: var(--text-main); font-size: 1.05rem; }
    .accordion-body { padding: 20px 0; background: transparent; }
    .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; cursor: pointer; border:1px solid var(--border); }

    /* PRINT */
    @media print {
        body * { visibility: hidden; }
        .print-area, .print-area * { visibility: visible; }
        .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; }
        .no-print { display: none !important; }
    }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- VIEW: LOGIN -->
    <section id="view-login" class="container">
        <div class="login-wrapper">
            <div class="login-card">
                <img src="https://i.imgur.com/xX4QN18.png" alt="Logo" class="app-logo">
                <h2 style="margin-bottom: 8px; color: var(--primary);">Sistem Presensi GMS</h2>
                <p style="color: var(--text-muted); margin-bottom: 32px; font-size: 0.95rem;">Selamat Datang</p>
                
                <label>Nama Lengkap</label>
                <input type="text" id="login-name" placeholder="Cth: Budi" autocomplete="off">
                
                <label style="margin-top:16px;">ID Pengguna</label>
                <div style="position: relative;">
                    <input type="password" id="login-id" placeholder="Cth: 001" style="padding-right: 45px;" autocomplete="off">
                    <div onclick="app.togglePassword()" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);">
                        <svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="eye-off-icon" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </div>
                </div>

                <button onclick="app.login()" class="btn btn-primary" style="margin-top:24px; width:100%;">Masuk Aplikasi</button>
            </div>
            
            <!-- FOOTER SESUAI REQUEST -->
            <div class="login-footer">
                <p class="brand-name">Graha Mega Solusindo</p>
                <p class="support-text">supported by : Klase Auto Graha</p>
            </div>
        </div>
    </section>

    <!-- VIEW: EMPLOYEE -->
    <section id="view-employee" class="container hidden">
        <div class="profile-header">
            <div class="profile-content">
                <div class="profile-avatar-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div>
                    <h2 id="emp-name" style="font-weight:700; font-size:1.2rem;">Nama User</h2>
                    <small id="emp-role" style="opacity:0.9; font-size:0.9rem;">Karyawan</small>
                </div>
            </div>
        </div>
        
        <div class="clock-widget">
            <div id="date-display">Senin, 1 Januari2024</div>
            <div id="time-display">00:00:00</div>
        </div>

        <div class="card" style="margin-top:-15px; padding:12px 20px; display:flex; align-items:center; gap:12px;">
            <div id="gps-dot" style="width:12px; height:12px; background:#ccc; border-radius:50%;"></div>
            <div style="flex:1;">
                <div id="gps-status-text" style="font-size:0.9rem; font-weight:700;">Mencari Lokasi...</div>
                <div id="gps-coords" style="font-size:0.75rem; color:var(--text-muted);">Lat: -, Lng: -</div>
            </div>
        </div>

        <div id="gps-rule-info" class="hidden" style="background:#e0e7ff; color:#3730a3; padding:14px 20px; border-radius:12px; margin-bottom:20px; font-size:0.85rem; border:1px solid #c7d2fe;">
            ‚ÑπÔ∏è Anda harus berada di radius <span id="rule-radius">0</span>m dari <span id="rule-loc">Lokasi</span>
        </div>

        <div class="marquee-strip">
            <div class="marquee-content">
                ‚ö†Ô∏è Jangan Lupa Presensi / Gunakan fitur pengajuan jika tidak masuk kerja Atau Lupa absen &nbsp;&nbsp;&nbsp; ‚ö†Ô∏è Waktu Presensi Terbatas
            </div>
        </div>

        <div class="clock-grid">
            <button onclick="app.openCamera('Masuk')" class="btn btn-success clock-btn"><span style="font-size:1.6rem;">üì•</span>Clock In</button>
            <button onclick="app.openCamera('Pulang')" class="btn btn-danger clock-btn"><span style="font-size:1.6rem;">üì§</span>Clock Out</button>
        </div>

        <!-- FORM PENGAJUAN -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-form').classList.toggle('hidden')">
                <span style="font-weight:700;">üìÑ Ajukan Izin / Sakit</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-form" class="hidden accordion-body">
                <label>Jenis Pengajuan</label>
                <select id="sub-type">
                    <option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Cuti">Cuti</option><option value="Lupa Absen">Lupa Absen</option>
                </select>
                <label>Tanggal Pengajuan</label>
                <input type="date" id="sub-date">
                <label>Keterangan (Max 100 Karakter)</label>
                <textarea id="sub-desc" style="font-size:0.95rem; min-height:80px;" placeholder="Tulis keterangan..."></textarea>
                <small id="char-count" style="display:block; margin-bottom:15px; font-size:0.75rem; color:var(--text-muted); text-align:right;">0/100 Karakter</small>
                <label>Upload Bukti (Foto)</label>
                <input type="file" id="sub-proof" accept="image/*">
                <button id="btn-submit-sub" onclick="app.submitPengajuan()" class="btn btn-primary" style="margin-top:15px;">Kirim Pengajuan</button>
            </div>
        </div>

        <!-- RIWAYAT -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-history').classList.toggle('hidden')">
                <span style="font-weight:700;">üìë Riwayat Pengajuan</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-history" class="accordion-body">
                <div id="history-list-sub">
                    <div style="text-align:center; padding:20px; color:#999;">Memuat riwayat...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:15px;">Riwayat Absen</h3>
            <div id="history-list-absen" style="margin-top:10px;">
                <div style="text-align:center; padding:10px; color:#999;">Belum ada data.</div>
            </div>
        </div>
        <button onclick="app.logout()" class="btn btn-outline">Keluar</button>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="container admin hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;" class="no-print">
            <h2>Admin Dashboard</h2>
            <button onclick="app.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap;" class="no-print">
            <button onclick="app.switchTab('employees', this)" class="tab-btn tab-emp active">Data Karyawan</button>
            <button onclick="app.switchTab('attendance', this)" class="tab-btn tab-att">Rekap Absen</button>
            <button onclick="app.switchTab('submissions', this)" class="tab-btn tab-sub">Pengajuan</button>
            <button onclick="app.refreshData()" class="btn btn-primary btn-sm" style="width:auto;">üîÑ Refresh</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Karyawan</div>
                <div class="stat-val" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--success);">Hadir Hari Ini</div>
                <div class="stat-val" id="stat-present" style="color:var(--success);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--danger);">Belum Hadir</div>
                <div class="stat-val" id="stat-absent" style="color:var(--danger);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--warning);">Pengajuan Pending</div>
                <div class="stat-val" id="stat-sub" style="color:var(--warning);">0</div>
            </div>
        </div>

        <!-- Tab Employees -->
        <div id="tab-employees" class="print-area">
            <div class="card" style="padding:0; overflow:hidden;">
                <div class="filter-bar no-print">
                    <input id="filter-emp-id" placeholder="Cari ID..." onkeyup="app.filterTable('admin-emp-table', 0, this.value)">
                    <input id="filter-emp-name" placeholder="Cari Nama..." onkeyup="app.filterTable('admin-emp-table', 1, this.value)">
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>
                <div style="padding:20px; background:#f8fafc; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center;" class="no-print">
                    <button onclick="app.showAddUserModal()" class="btn btn-primary btn-sm">+ Tambah Manual</button>
                    <button onclick="document.getElementById('import-csv').click()" class="btn btn-success btn-sm">üìÇ Import CSV</button>
                    <input type="file" id="import-csv" accept=".csv" style="display:none" onchange="app.handleImport(this)">
                    <small style="font-size:0.7rem; color:#888;">Format: ID,Nama,Role,Lokasi,GPS,Lat,Lng,Radius</small>
                </div>
                <div class="table-container">
                    <table id="admin-emp-table">
                        <thead><tr><th>ID</th><th>Nama</th><th>Role</th><th>Lokasi</th><th>Mode GPS</th><th>Lat, Lng</th><th>Radius</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Attendance -->
        <div id="tab-attendance" class="print-area hidden">
            <div class="card" style="padding:0; overflow:hidden;">
                 <div class="filter-bar no-print">
                    <input type="month" id="filter-att-month" placeholder="Filter Bulan" onchange="app.renderAttendanceTable()">
                    <input id="filter-att-name" placeholder="Cari Nama..." onkeyup="app.renderAttendanceTable()">
                    <button onclick="app.exportToExcel()" class="btn btn-excel btn-sm">üìä Download Excel</button>
                    <button onclick="window.print()" class="btn btn-print btn-sm">  Print </button>
                </div>
                <div class="table-container">
                    <table id="admin-att-table">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Tipe</th><th>Lokasi (Lat, Lng)</th><th>Foto</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Submissions -->
        <div id="tab-submissions" class="print-area hidden">
            <div class="card" style="padding:0; overflow:hidden;">
                <div class="filter-bar no-print">
                    <select id="filter-sub-status" onchange="app.renderSubmissionTable()">
                        <option value="">Semua Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>
                <div class="table-container">
                    <table id="admin-sub-table">
                        <thead><tr><th>Tgl</th><th>Nama</th><th>Tipe</th><th>Keterangan</th><th>Bukti</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALS -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="user-modal-title" style="margin-bottom:20px; font-weight:700;">Tambah Karyawan</h3>
            <input type="hidden" id="old-id">
            <label>ID Karyawan</label><input type="text" id="new-id">
            <label>Nama Lengkap</label><input type="text" id="new-name">
            <label>Password (Login)</label><input type="text" id="new-pass" placeholder="Isi password">
            <label>Role</label>
            <select id="new-role"><option value="employee">Employee</option><option value="admin">Admin</option></select>
            
            <div style="margin:20px 0; border-top:1px solid #eee; padding-top:20px;">
                <label style="color:var(--primary);">Pengaturan Lokasi & GPS</label>
                <label>Nama Lokasi</label><input type="text" id="new-workloc">
                <label>Mode GPS</label>
                <select id="new-gpsmode" onchange="app.toggleGpsInputs()">
                    <option value="bebas">Bebas</option>
                    <option value="terkunci">Terkunci</option>
                </select>
                <div id="gps-inputs" class="hidden">
                    <label>Lat / Lng</label>
                    <div class="input-group">
                        <input type="text" id="new-lat" placeholder="Latitude">
                        <input type="text" id="new-lng" placeholder="Longitude">
                    </div>
                    <button onclick="app.getCurrentLocForAdmin()" class="btn btn-outline btn-sm" style="margin-bottom:10px; width:100%;">üìç Pakai Lokasi Saya</button>
                    <label>Radius (meter)</label><input type="number" id="new-radius" value="100">
                </div>
            </div>
            <div class="input-group">
                <button onclick="document.getElementById('user-modal').style.display='none'" class="btn btn-outline">Batal</button>
                <button id="btn-save-user" onclick="app.saveNewUser()" class="btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h3 id="cam-action" style="margin-bottom:15px;">Clock In</h3>
            <video id="webcam" autoplay playsinline></video>
            <div class="input-group" style="margin-top:20px;">
                <button onclick="app.closeCamera()" class="btn btn-outline">Batal</button>
                <button onclick="app.takePhoto()" class="btn btn-primary">Ambil & Kirim</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    // --- KONFIGURASI ---
    const SUPABASE_URL = 'https://scvzpmmgbpznacitogta.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdnpwbW1nYnB6bmFjaXRvZ3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NTE1NTYsImV4cCI6MjA4NTAyNzU1Nn0.ujiG2BoQFs0_ZHyZCqCpjMtimCHvjtyLRbJbAy9Pl3A';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // GANTI DENGAN NOMOR WA ADMIN (Format: 628...)
    const ADMIN_WA_NUMBER = '6285693456415'; 

    // --- DATABASE OBJECT ---
    const DB = {
        getTable: async (table) => {
            let { data, error } = await supabase.from(table).select('*');
            if (error) { console.error(error); return []; }
            return data;
        },
        getUsers: async () => DB.getTable('users'),
        getAttendance: async () => DB.getTable('attendance'),
        getSubmissions: async () => DB.getTable('submissions'),
        addUser: async (u) => {
            const payload = {
                name: u.Name, id_user: u.ID, role: u.Role, work_location: u.WorkLocation,
                gps_mode: u.GPSMode, target_lat: parseFloat(u.TargetLat) || null,
                target_lng: parseFloat(u.TargetLng) || null, radius: parseInt(u.Radius) || 100
            };
            await supabase.from('users').insert([payload]);
        },
        batchAddUsers: async (usersArray) => {
            const payload = usersArray.map(u => ({
                name: u[1], id_user: u[0], role: u[2], work_location: u[3],
                gps_mode: u[4], target_lat: parseFloat(u[5]) || null,
                target_lng: parseFloat(u[6]) || null, radius: parseInt(u[7]) || 100
            }));
            await supabase.from('users').insert(payload);
        },
        updateUser: async (newU, oldId) => { 
            const { error } = await supabase
                .from('users')
                .update({
                    name: newU.Name, id_user: newU.ID, role: newU.Role,
                    work_location: newU.WorkLocation, gps_mode: newU.GPSMode,
                    target_lat: parseFloat(newU.TargetLat) || null,
                    target_lng: parseFloat(newU.TargetLng) || null,
                    radius: parseInt(newU.Radius) || 100
                })
                .eq('id_user', oldId);
            if(error) alert("Gagal update: " + error.message);
        },
        deleteUser: async (id) => {
            const { error } = await supabase.from('users').delete().eq('id_user', id);
            if(error) console.error(error);
        },
        addAttendance: async (att) => {
            const payload = {
                user_id: att.UserID, name: att.Name, type: att.Type,
                timestamp: new Date(att.Timestamp).toISOString(),
                lat: att.Lat, lng: att.Lng, photo_url: att.PhotoURL
            };
            const { error } = await supabase.from('attendance').insert([payload]);
            if(error) alert("Gagal Absen: " + error.message);
        },
        addSubmission: async (sub) => {
            const payload = {
                user_id: sub.UserID, name: sub.Name, type: sub.Type,
                date: sub.Date, description: sub.Desc, proof_url: sub.ProofURL, status: 'Pending'
            };
            const { error } = await supabase.from('submissions').insert([payload]);
            if(error) alert("Gagal Submit: " + error.message);
        },
        updateSubmission: async (idx, status, reason) => {
            const { error } = await supabase
                .from('submissions')
                .update({ status: status, reason: reason })
                .eq('id', idx); 
            if(error) alert("Gagal Update: " + error.message);
        }
    };

    const $ = id => document.getElementById(id);

    function showToast(msg, type='success') {
        const c = $('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = type === 'success' ? '‚úÖ ' + msg : '‚ö†Ô∏è ' + msg;
        c.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
    }

    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); var d = R * c; return d * 1000;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    const app = {
        data: { currentUser: null, currentLocation: null, stream: null, allAttendance: [], allSubmissions: [] },

        init: async function() {
            const session = sessionStorage.getItem('gms_user');
            if(session) {
                this.data.currentUser = JSON.parse(session);
                this.route();
            }
        },

        togglePassword: function() {
            const input = $('login-id');
            if (input.type === "password") {
                input.type = "text"; $('eye-icon').classList.add('hidden'); $('eye-off-icon').classList.remove('hidden');
            } else {
                input.type = "password"; $('eye-icon').classList.remove('hidden'); $('eye-off-icon').classList.add('hidden');
            }
        },

        login: async function() {
            const id = $('login-id').value.trim();
            const name = $('login-name').value.trim();

            // --- 1. LOGIN SUPER ADMIN ---
            if (id === 'klase123#' && name.toLowerCase() === 'rio klase') {
                const superAdminUser = {
                    ID: 'klase123#',
                    Name: 'Rio Klase',
                    Role: 'admin', 
                    WorkLocation: 'Kantor Pusat',
                    GPSMode: 'bebas'
                };
                this.data.currentUser = superAdminUser;
                sessionStorage.setItem('gms_user', JSON.stringify(superAdminUser));
                showToast(`Selamat Datang, Super Admin ${superAdminUser.Name}`);
                this.route();
                return;
            }
            // ------------------------------------------

            // --- 2. LOGIN NORMAL ---
            if(!SUPABASE_URL.includes('http')) return showToast("Supabase URL belum diisi!", "error");

            const users = await DB.getUsers();
            const user = users.find(u => u.id_user === id); 
            
            if(user) {
                let valid = false;
                if(user.name.toLowerCase() === name.toLowerCase()) valid = true;

                if(valid) {
                    const appUser = {
                        ID: user.id_user, Name: user.name, Role: user.role, WorkLocation: user.work_location,
                        GPSMode: user.gps_mode, TargetLat: user.target_lat, TargetLng: user.target_lng, Radius: user.radius
                    };
                    this.data.currentUser = appUser;
                    sessionStorage.setItem('gms_user', JSON.stringify(appUser));
                    showToast(`Selamat datang, ${appUser.Name}`);
                    this.route();
                } else {
                    showToast("Nama / ID Salah!", "error");
                }
            } else {
                showToast("ID Tidak ditemukan di Database", "error");
            }
        },

        logout: function() { sessionStorage.clear(); location.reload(); },

        route: function() {
            $('view-login').classList.add('hidden');
            if(this.data.currentUser.Role === 'admin') {
                $('view-admin').classList.remove('hidden');
                this.renderEmployees();
                this.refreshData();
            } else {
                $('view-employee').classList.remove('hidden');
                this.initEmployeeDashboard();
            }
        },

        updateClock: function() {
            const now = new Date();
            document.getElementById('date-display').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('time-display').textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        },

        initEmployeeDashboard: async function() {
            const u = this.data.currentUser;
            $('emp-name').textContent = u.Name;
            $('emp-role').textContent = u.WorkLocation || "Karyawan";
            if(u.GPSMode === 'terkunci') {
                $('gps-rule-info').classList.remove('hidden');
                $('rule-radius').textContent = u.Radius;
                $('rule-loc').textContent = u.WorkLocation || "Titik Terkunci";
            } else {
                $('gps-rule-info').classList.add('hidden');
            }
            this.updateClock(); setInterval(() => this.updateClock(), 1000);
            this.getLocation();
            this.loadMySubmissions();
            this.checkTodayStatus();
        },
        
        getLocation: function() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    this.data.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    $('gps-status-text').textContent = "Lokasi Terkunci ‚úÖ";
                    $('gps-coords').textContent = `${this.data.currentLocation.lat.toFixed(5)}, ${this.data.currentLocation.lng.toFixed(5)}`;
                    $('gps-dot').style.background = "var(--success)";
                }, err => {
                    $('gps-status-text').textContent = "GPS Gagal ‚ùå";
                    $('gps-dot').style.background = "var(--danger)";
                });
            } else {
                $('gps-status-text').textContent = "Browser tidak support";
            }
        },

        submitPengajuan: async function() {
            const btn = $('btn-submit-sub');
            const type = $('sub-type').value;
            const date = $('sub-date').value;
            const desc = $('sub-desc').value;
            const fileInput = $('sub-proof');
            
            if(!date) return showToast("Harap pilih tanggal!", "error");
            if(desc.length > 100) return showToast(`Keterangan terlalu panjang! Max 100 kar. (${desc.length})`, "error");

            // Spinner Loading
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Sedang Mengirim...';
            btn.disabled = true;

            // Handle Upload (Simulasi URL)
            let proofUrl = `https://picsum.photos/seed/${Date.now()}/200/200`;
            if(fileInput.files && fileInput.files[0]) {
                // Di production, ini akan upload ke Supabase Storage
            }

            try {
                await DB.addSubmission({
                    UserID: this.data.currentUser.ID, Name: this.data.currentUser.Name, Type: type, Date: date, Desc: desc, ProofURL: proofUrl
                });

                showToast("Pengajuan terkirim ke Database!");
                $('sub-form').classList.add('hidden');
                $('sub-desc').value = "";
                
                // --- KIRIM NOTIFIKASI WA ---
                const text = `*PENGAJUAN BARU*%0A%0ANama: ${this.data.currentUser.Name}%0ATipe: ${type}%0ATgl: ${date}%0AIsi: ${desc}`;
                window.open(`https://wa.me/${ADMIN_WA_NUMBER}?text=${text}`, '_blank');

                this.loadMySubmissions();
            } catch (e) {
                showToast("Gagal mengirim!", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        },

        loadMySubmissions: async function() {
            const list = $('history-list-sub');
            const allSubs = await DB.getSubmissions();
            const mySubs = allSubs.filter(s => s.user_id === this.data.currentUser.ID).reverse();
            
            if(mySubs.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Belum ada pengajuan.</div>'; return; }

            list.innerHTML = mySubs.map(row => {
                let statusBadge = '';
                if(row.status === 'Pending') statusBadge = '<span class="badge badge-warning">‚è≥ Pending</span>';
                if(row.status === 'Approved') statusBadge = '<span class="badge badge-success">‚úÖ Disetujui</span>';
                if(row.status === 'Rejected') statusBadge = '<span class="badge badge-danger">‚ùå Ditolak</span>';

                return `
                    <div style="padding:15px 0; border-bottom:1px solid #eee;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-muted);">
                            <span>${row.date}</span>
                            ${statusBadge}
                        </div>
                        <div style="font-weight:600; margin:4px 0; color:var(--text-main);">${row.type}</div>
                        <div style="font-size:0.9rem; color:#555; line-height:1.4;">${row.description}</div>
                        ${row.status === 'Rejected' ? `<div style="color:red; font-size:0.8rem; margin-top:6px;">Alasan: ${row.reason}</div>` : ''}
                    </div>
                `;
            }).join('');
        },

        openCamera: function(type) {
            this.currentAction = type;
            $('cam-action').textContent = type === 'Masuk' ? 'Clock In' : 'Clock Out';
            $('camera-modal').style.display = 'flex';
            
            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                .then(s => { 
                    this.data.stream = s; 
                    $('webcam').srcObject = s; 
                })
                .catch(err => {
                    alert("Tidak bisa akses kamera.");
                    this.closeCamera();
                });
            }
        },

        closeCamera: function() {
            if(this.data.stream) this.data.stream.getTracks().forEach(t => t.stop());
            $('camera-modal').style.display = 'none';
        },

        takePhoto: async function() {
            if(!this.data.currentLocation && $('gps-status-text').textContent !== "Lokasi Terkunci ‚úÖ") {
                this.data.currentLocation = {lat: 0, lng: 0}; 
            }

            if(this.data.currentUser.GPSMode === 'terkunci') {
                const u = this.data.currentUser; const cur = this.data.currentLocation;
                if(!u.TargetLat || !u.TargetLng) { showToast("Koordinat kantor belum disetting admin.", "error"); return; }
                const distance = getDistanceFromLatLonInM(cur.lat, cur.lng, parseFloat(u.TargetLat), parseFloat(u.TargetLng));
                if(distance > parseFloat(u.Radius)) {
                    showToast(`Gagal! Jarak ${Math.floor(distance)}m dari kantor (Max: ${u.Radius}m)`, "error");
                    return;
                }
            }

            const allAtt = await DB.getAttendance();
            const todayStr = new Date().toISOString().split('T')[0];
            const myAttToday = allAtt.filter(a => a.user_id === this.data.currentUser.ID && a.timestamp.startsWith(todayStr));
            const alreadyDone = myAttToday.some(a => a.type === this.currentAction);

            if(alreadyDone) {
                showToast(`Anda sudah melakukan ${this.currentAction} hari ini!`, "error");
                this.closeCamera();
                return;
            }

            const photoUrl = `https://picsum.photos/seed/${Date.now()}/200/300`; 

            await DB.addAttendance({
                UserID: this.data.currentUser.ID, Name: this.data.currentUser.Name, Type: this.currentAction,
                Timestamp: new Date().toISOString(), Lat: this.data.currentLocation.lat, Lng: this.data.currentLocation.lng, PhotoURL: photoUrl
            });

            showToast("Absen Berhasil tersimpan ke Server!");
            this.closeCamera();
            
            const list = $('history-list-absen');
            const item = document.createElement('div');
            item.className = "history-item";
            item.innerHTML = `
                <div>
                    <div class="history-status">${this.currentAction} ‚úÖ</div>
                    <div class="history-loc">üìç ${this.data.currentLocation.lat.toFixed(4)}, ${this.data.currentLocation.lng.toFixed(4)}</div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-muted);">${new Date().toLocaleTimeString()}</div>
            `;
            list.prepend(item);
            this.checkTodayStatus();
        },

        checkTodayStatus: async function() {
            const list = $('history-list-absen');
            const allAtt = await DB.getAttendance();
            const myAtt = allAtt.filter(a => a.user_id === this.data.currentUser.ID).reverse();
            
            if(myAtt.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:10px; color:#999;">Belum ada data hari ini.</div>';
            } else {
                list.innerHTML = myAtt.map(row => `
                    <div class="history-item">
                        <div>
                            <div class="history-status">${row.type}</div>
                            <div class="history-loc">üìç ${row.lat.toFixed(4)}, ${row.lng.toFixed(4)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:600;">${new Date(row.timestamp).toLocaleTimeString()}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${new Date(row.timestamp).toLocaleDateString()}</div>
                        </div>
                    </div>
                `).join('');
            }
        },

        switchTab: function(tab, btn) {
            const allTabs = document.querySelectorAll('.tab-btn');
            allTabs.forEach(t => { t.classList.remove('active'); });
            btn.classList.add('active');
            $('tab-employees').classList.add('hidden');
            $('tab-attendance').classList.add('hidden');
            $('tab-submissions').classList.add('hidden');
            $(`tab-${tab}`).classList.remove('hidden');
        },

        renderEmployees: async function() {
            const users = await DB.getUsers();
            const tbody = $('admin-emp-table').querySelector('tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id_user}</td><td>${u.name}</td><td>${u.role}</td><td>${u.work_location || '-'}</td>
                    <td><span style="padding:2px 6px; border-radius:4px; background:${u.gps_mode==='terkunci'?'#fee2e2':'#d1fae5'}; color:${u.gps_mode==='terkunci'?'red':'green'}">${u.gps_mode || 'bebas'}</span></td>
                    <td>${u.target_lat || 0}, ${u.target_lng || 0}</td><td>${u.radius || 0}m</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="app.openEditModal('${u.id_user}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="app.deleteUser('${u.id_user}')">Hapus</button>
                    </td>
                </tr>
            `).join('');
        },

        // --- 1. FUNGSI EDIT KARYAWAN (REAL) ---
        openEditModal: async function(id) {
            const users = await DB.getUsers();
            const user = users.find(u => u.id_user == id);
            if(!user) return;

            $('user-modal-title').textContent = "Edit Karyawan";
            $('old-id').value = user.id_user;
            
            // Isi Form
            $('new-id').value = user.id_user;
            $('new-id').readOnly = true; // ID tidak boleh diubah saat edit
            $('new-name').value = user.name;
            $('new-role').value = user.role;
            $('new-workloc').value = user.work_location || "";
            $('new-gpsmode').value = user.gps_mode || "bebas";
            $('new-lat').value = user.target_lat || "";
            $('new-lng').value = user.target_lng || "";
            $('new-radius').value = user.radius || 100;
            
            this.toggleGpsInputs();
            $('btn-save-user').onclick = () => app.saveEditUser();
            $('user-modal').style.display = 'flex';
        },

        saveEditUser: async function() {
            await DB.updateUser({
                ID: $('new-id').value, 
                Name: $('new-name').value, 
                Role: $('new-role').value, 
                WorkLocation: $('new-workloc').value, 
                GPSMode: $('new-gpsmode').value,
                TargetLat: $('new-lat').value, 
                TargetLng: $('new-lng').value, 
                Radius: $('new-radius').value
            }, $('old-id').value);
            
            showToast("User Diupdate");
            $('user-modal').style.display = 'none';
            this.refreshData();
        },

        // --- ADMIN FUNCTIONS ---
        handleImport: function(input) {
            const file = input.files[0]; 
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n');
                const dataToInsert = [];
                for(let i =1; i < rows.length; i++) {
                    const cols = rows[i].split(',');
                    if(cols.length >= 2 && cols[0].trim() !== "") {
                        dataToInsert.push(cols.map(c => c.trim()));
                    }
                }
                if(dataToInsert.length > 0) {
                    await DB.batchAddUsers(dataToInsert);
                    showToast(`Berhasil import ${dataToInsert.length} karyawan!`);
                    this.refreshData();
                } else {
                    showToast("Format CSV salah", "error");
                }
                input.value = "";
            };
            reader.readAsText(file);
        },

        renderAttendanceTable: async function() {
            const allAtt = await DB.getAttendance();
            this.data.allAttendance = allAtt;

            const fMonth = $('filter-att-month').value;
            const fName = $('filter-att-name').value.toLowerCase();

            const filtered = allAtt.filter(row => {
                let matchDate = true;
                let matchName = true;
                if(fMonth) matchDate = row.timestamp.startsWith(fMonth);
                if(fName) matchName = row.name.toLowerCase().includes(fName);
                return matchDate && matchName;
            });

            filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tbody = $('admin-att-table').querySelector('tbody');
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Data tidak ditemukan.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(row => `
                <tr><td>${new Date(row.timestamp).toLocaleString()}</td><td>${row.name}</td><td>${row.type}</td><td>${row.lat}, ${row.lng}</td>
                <td><img src="${row.photo_url}" class="thumb-img"></td></tr>
            `).join('');
        },

        exportToExcel: function() {
            if(this.data.allAttendance.length === 0) return showToast("Tidak ada data!", "error");
            const fMonth = $('filter-att-month').value;
            const fName = $('filter-att-name').value.toLowerCase();

            const filtered = this.data.allAttendance.filter(row => {
                let matchDate = true; let matchName = true;
                if(fMonth) matchDate = row.timestamp.startsWith(fMonth);
                if(fName) matchName = row.name.toLowerCase().includes(fName);
                return matchDate && matchName;
            });

            const exportData = filtered.map(row => ({
                Tanggal: new Date(row.timestamp).toLocaleDateString('id-ID'),
                Jam: new Date(row.timestamp).toLocaleTimeString('id-ID'),
                ID_Karyawan: row.user_id,
                Nama_Karyawan: row.name,
                Jenis_Absen: row.type,
                Latitude: row.lat,
                Longitude: row.lng,
                Link_Foto: row.photo_url
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap Absen");
            XLSX.writeFile(wb, `Rekap_Absensi_${fMonth || 'All'}.xlsx`);
            showToast("Excel didownload!");
        },

        renderStats: async function() {
            const users = await DB.getUsers();
            const atts = await DB.getAttendance();
            const subs = await DB.getSubmissions();
            
            const totalEmp = users.filter(u => u.role === 'employee').length;
            $('stat-total').textContent = totalEmp;

            const todayStr = new Date().toISOString().split('T')[0];
            const presentUsers = new Set(atts.filter(a => a.timestamp.startsWith(todayStr)).map(a => a.user_id));
            $('stat-present').textContent = presentUsers.size;
            $('stat-absent').textContent = totalEmp - presentUsers.size;

            const pendingSubs = subs.filter(s => s.status === 'Pending').length;
            $('stat-sub').textContent = pendingSubs;
        },

        showAddUserModal: function() {
            $('user-modal-title').textContent = "Tambah Karyawan";
            $('old-id').value = "";
            $('new-id').value = ""; 
            $('new-id').readOnly = false;
            $('new-name').value = ""; 
            $('new-role').value = "employee"; 
            $('new-workloc').value = "";
            $('new-gpsmode').value = "bebas"; 
            $('new-lat').value = ""; 
            $('new-lng').value = ""; 
            $('new-radius').value = 100;
            this.toggleGpsInputs();
            $('btn-save-user').onclick = () => app.saveNewUser();
            $('user-modal').style.display = 'flex';
        },

        toggleGpsInputs: function() {
            const mode = $('new-gpsmode').value;
            if(mode === 'terkunci') $('gps-inputs').classList.remove('hidden');
            else $('gps-inputs').classList.add('hidden');
        },

        getCurrentLocForAdmin: function() {
            if(navigator.geolocation) {
                $('new-lat').value = "Mencari...";
                navigator.geolocation.getCurrentPosition(pos => {
                    $('new-lat').value = pos.coords.latitude;
                    $('new-lng').value = pos.coords.longitude;
                });
            }
        },

        saveNewUser: async function() {
            const payload = {
                ID: $('new-id').value, Name: $('new-name').value, Role: $('new-role').value, 
                WorkLocation: $('new-workloc').value, GPSMode: $('new-gpsmode').value,
                TargetLat: $('new-lat').value, TargetLng: $('new-lng').value, Radius: $('new-radius').value
            };
            if(!payload.ID || !payload.Name) return showToast("ID dan Nama Wajib!", "error");
            await DB.addUser(payload);
            showToast("User Disimpan");
            $('user-modal').style.display = 'none';
            this.refreshData();
        },

        deleteUser: async function(id) {
            if(!confirm("Hapus user ini?")) return;
            await DB.deleteUser(id);
            showToast("User Dihapus");
            this.refreshData();
        },

        filterTable: function(tableId, colIndex, val) {
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");
            val = val.toUpperCase();
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[colIndex];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(val) > -1 ? "" : "none";
                }
            }
        },

        refreshData: function() {
            this.renderEmployees();
            this.renderStats();
            this.renderAttendanceTable();
            this.renderSubmissionTable();
        },
        
        renderSubmissionTable: async function() {
            const allSubs = await DB.getSubmissions();
            const fStatus = $('filter-sub-status').value;
            const filtered = fStatus ? allSubs.filter(r => r.status === fStatus) : allSubs;

            $('admin-sub-table').querySelector('tbody').innerHTML = filtered.map((row) => {
                 const actions = (row.status === 'Pending') ? `
                    <button class="btn btn-success btn-sm" onclick="app.updateSubmissionStatus(${row.id}, 'Approved')">Setuju</button>
                    <button class="btn btn-danger btn-sm" onclick="app.rejectSubmission(${row.id})">Tolak</button>
                ` : (row.status === 'Rejected' ? `<small>${row.reason||'-'}</small>` : '-');

                return `
                <tr>
                    <td>${row.date}</td><td>${row.name}</td><td>${row.type}</td>
                    <td>${row.description.substring(0, 30)}...</td>
                    <td><img src="${row.proof_url}" class="thumb-img"></td>
                    <td><span style="font-weight:bold; color:${row.status==='Approved'?'green':(row.status==='Rejected'?'red':'orange')}">${row.status}</span></td>
                    <td>${actions}</td>
                </tr>
            `}).join('');
        },

        updateSubmissionStatus: async function(idx, status) {
            if(!confirm(`Ubah status menjadi ${status}?`)) return;
            await DB.updateSubmission(idx, status, '');
            showToast("Status diperbarui");
            this.refreshData();
        },

        rejectSubmission: async function(idx) {
            const reason = prompt("Masukkan alasan penolakan:");
            if(reason !== null) {
                await DB.updateSubmission(idx, 'Rejected', reason);
                showToast("Status diperbarui");
                this.refreshData();
            }
        }
    };

    $('sub-desc').addEventListener('input', function(e) { 
        $('char-count').textContent = e.target.value.length + "/100 Karakter"; 
    });
    
    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
