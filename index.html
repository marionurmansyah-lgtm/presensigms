<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presensi GMS</title>

  <!-- FONT AWESOME -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fb;
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      max-width: 420px;
      margin: auto;
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }

    .btn-primary {
      background: #2a5298;
      color: #fff;
    }

    .btn-danger {
      background: #e74c3c;
      color: #fff;
      margin-top: 10px;
    }

    .hidden { display: none; }

    /* CAMERA */
    .camera-modal {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;
    }

    .camera-modal video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-controls {
      position: absolute;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: space-around;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="card">
  <h2>Login Presensi</h2>
  <input id="loginNama" placeholder="Nama">
  <input id="loginNik" placeholder="ID Karyawan">
  <button class="btn-primary" onclick="login()">
    <i class="fa-solid fa-right-to-bracket"></i> Login
  </button>
</div>

<!-- USER DASHBOARD -->
<div id="userDashboard" class="card hidden">
  <h2>Dashboard</h2>
  <p id="welcome"></p>

  <button class="btn-primary" onclick="startClockIn()">
    <i class="fa-solid fa-camera"></i> Clock In
  </button>

  <button class="btn-danger" onclick="logout()">
    <i class="fa-solid fa-right-from-bracket"></i> Logout
  </button>
</div>

<!-- CAMERA -->
<div id="cameraModal" class="camera-modal hidden">
  <video id="cameraVideo" autoplay playsinline></video>

  <div class="camera-controls">
    <button class="btn-danger" onclick="closeCamera()">‚ùå</button>
    <button class="btn-primary" onclick="capturePhoto()">üì∏</button>
  </div>

  <canvas id="cameraCanvas" class="hidden"></canvas>
</div>

<script>
  // ================= CONFIG =================
  const API_URL = 'https://script.google.com/macros/s/AKfycbwP8_Z8lXpHob8pKmQwI4P-8eU84u39Zl-ZRXpQCSWmK99DyxUjqWqfGUro8NoIJcHm/exec';

  let currentUser = null;
  let cameraStream = null;
  let photoBase64 = '';

  // ================= LOGIN =================
  async function login() {
    const nama = loginNama.value.trim();
    const nik  = loginNik.value.trim();

    if (!nama || !nik) {
      alert('Nama & ID wajib diisi');
      return;
    }

    const res = await fetch(
      `${API_URL}?action=login&nik=${encodeURIComponent(nik)}&nama=${encodeURIComponent(nama)}`
    );
    const json = await res.json();

    if (!json.success) {
      alert(json.message);
      return;
    }

    currentUser = { nik, nama, role: json.role };
    localStorage.setItem('user', JSON.stringify(currentUser));

    loginPage.classList.add('hidden');
    userDashboard.classList.remove('hidden');
    welcome.innerText = `Halo, ${nama}`;
  }

  function logout() {
    localStorage.clear();
    location.reload();
  }

  // ================= CAMERA =================
  async function startClockIn() {
    cameraModal.classList.remove('hidden');
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    cameraVideo.srcObject = cameraStream;
  }

  function closeCamera() {
    cameraModal.classList.add('hidden');
    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
  }

  function capturePhoto() {
    const canvas = cameraCanvas;
    const ctx = canvas.getContext('2d');

    canvas.width = cameraVideo.videoWidth;
    canvas.height = cameraVideo.videoHeight;
    ctx.drawImage(cameraVideo, 0, 0);

    photoBase64 = canvas.toDataURL('image/jpeg', 0.7)
      .replace(/^data:image\/jpeg;base64,/, '');

    closeCamera();
    submitClockIn();
  }

  // ================= SUBMIT =================
  async function submitClockIn() {
    const form = new FormData();
    form.append('action', 'clock_in');
    form.append('nik', currentUser.nik);
    form.append('nama', currentUser.nama);
    form.append('foto', photoBase64);
    form.append('lokasi', 'Manual');

    const res = await fetch(API_URL, {
      method: 'POST',
      body: form
    });

    const json = await res.json();
    alert(json.message || 'Selesai');
  }
</script>

</body>
</html>
