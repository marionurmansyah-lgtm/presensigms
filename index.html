<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presensi GMS</title>

<!-- ICON & CHART -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
.hidden{display:none}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:15px;box-shadow:0 8px 25px rgba(0,0,0,.08)}
.btn{padding:12px;border:none;border-radius:8px;font-size:14px;cursor:pointer}
.btn-primary{background:#2a5298;color:#fff}
.btn-danger{background:#e74c3c;color:#fff}
.btn-success{background:#27ae60;color:#fff}
input,select{width:100%;padding:10px;margin-top:6px;margin-bottom:12px;border-radius:6px;border:1px solid #ccc}
nav{background:#2a5298;color:#fff;padding:12px}
nav span{font-weight:bold}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.badge{background:#e74c3c;color:#fff;padding:3px 8px;border-radius:12px;font-size:12px}
video{width:100%;border-radius:10px}
canvas{max-width:100%}
</style>
</head>

<body>

<nav>
  <span>Presensi GMS</span>
  <button class="btn btn-danger" style="float:right" onclick="logout()">Logout</button>
</nav>

<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="card">
  <center>
    <img src="data:image/png;base64,LOGO_BASE64_DI_SINI" width="120"><br><br>
    <b>Sistem Presensi Digital</b>
  </center><br>
  <input id="loginNama" placeholder="Nama Lengkap">
  <input id="loginId" placeholder="ID Karyawan">
  <button class="btn btn-primary" onclick="login()">Login</button>
</div>

<!-- USER DASHBOARD -->
<div id="userDash" class="hidden">

  <div class="card">
    <b id="userInfo"></b><br>
    <small id="userLokasi"></small>
  </div>

  <div class="grid">
    <button class="btn btn-success" onclick="openCamera('in')">
      <i class="fa fa-camera"></i> Clock In
    </button>
    <button class="btn btn-danger" onclick="openCamera('out')">
      <i class="fa fa-camera"></i> Clock Out
    </button>
  </div>

  <div class="card">
    <h3>Pengajuan</h3>
    <select id="jenis">
      <option>Izin</option>
      <option>Sakit</option>
      <option>Cuti</option>
    </select>
    <input id="alasan" placeholder="Alasan">
    <button class="btn btn-primary" onclick="kirimPengajuan()">Kirim</button>
  </div>

  <div class="card">
    <h3>Riwayat Absensi</h3>
    <div id="riwayat"></div>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDash" class="hidden">

  <div class="grid">
    <div class="card"><canvas id="chartHadir"></canvas></div>
    <div class="card"><canvas id="chartRanking"></canvas></div>
  </div>

  <div class="card">
    <h3>Approval Pengajuan</h3>
    <div id="listPengajuan"></div>
  </div>

  <div class="card">
    <button class="btn btn-primary" onclick="downloadAbsensi()">
      <i class="fa fa-download"></i> Download Rekap
    </button>
  </div>

</div>

<!-- CAMERA -->
<div id="camBox" class="hidden card">
  <video id="video" autoplay></video><br><br>
  <button class="btn btn-success" onclick="capture()">Ambil Foto</button>
  <button class="btn btn-danger" onclick="closeCam()">Batal</button>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzrS_SSkeStNLrdppule2LxSCZGOyby9L4ekAfzHUdERbRBFqd82hGkI6_h3BpxI-M4YA/exec";
let user={},modeCam="",stream,photo="";

async function login(){
  let nama=loginNama.value,id=loginId.value;
  let r=await fetch(`${API}?action=login&id=${id}&nama=${nama}`);
  let j=await r.json();
  if(!j.success){alert("Login gagal");return;}
  user=j.data;
  loginBox.classList.add("hidden");
  if(user.role==="AdminGMS001"){adminDash.classList.remove("hidden");loadAdmin();}
  else{userDash.classList.remove("hidden");loadUser();}
}

function logout(){localStorage.clear();location.reload();}

async function openCamera(m){
  modeCam=m;
  camBox.classList.remove("hidden");
  stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
}

function closeCam(){
  camBox.classList.add("hidden");
  stream.getTracks().forEach(t=>t.stop());
}

function capture(){
  let c=document.createElement("canvas");
  c.width=video.videoWidth;c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  photo=c.toDataURL("image/jpeg").replace(/^data:image\/jpeg;base64,/,"");
  closeCam();
  submitAbsen();
}

async function submitAbsen(){
  navigator.geolocation.getCurrentPosition(async p=>{
    let url=`${API}?action=${modeCam==="in"?"clockIn":"clockOut"}&id=${user.id}&nama=${user.nama}&lat=${p.coords.latitude}&lng=${p.coords.longitude}&foto=${photo}`;
    let r=await fetch(url);let j=await r.json();
    alert(j.message);
  });
}

async function kirimPengajuan(){
  let url=`${API}?action=pengajuan&id=${user.id}&nama=${user.nama}&jenis=${jenis.value}&alasan=${alasan.value}`;
  let r=await fetch(url);alert("Terkirim");
}

async function loadUser(){
  userInfo.innerText=user.nama+" ("+user.id+")";
}

async function loadAdmin(){
  new Chart(chartHadir,{type:"bar",data:{labels:["Hadir","Tidak"],datasets:[{data:[12,3],backgroundColor:["#27ae60","#e74c3c"]}]}});
  new Chart(chartRanking,{type:"line",data:{labels:["A","B","C"],datasets:[{data:[20,15,10],borderColor:"#2a5298"}]}});
}

function downloadAbsensi(){
  window.open(`${API}?action=downloadAbsensi`);
}
</script>

</body>
</html>
