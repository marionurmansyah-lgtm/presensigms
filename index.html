<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistem Presensi â€“ Graha Mega Solusindo</title>

<!-- STYLE -->
<style>
body{margin:0;font-family:Inter,Arial;background:#f4f6fb;color:#111}
header{background:#0f2a44;color:#fff;padding:16px;text-align:center}
.card{background:#fff;border-radius:14px;padding:16px;margin:12px}
.btn{padding:12px;border-radius:10px;border:none;font-weight:600;cursor:pointer}
.primary{background:#0f2a44;color:#fff}
.success{background:#16a34a;color:#fff}
.danger{background:#dc2626;color:#fff}
.secondary{background:#64748b;color:#fff}
.small{font-size:13px;color:#555}
.hidden{display:none}
input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc}
h3{margin:0 0 8px}
footer{text-align:center;color:#999;font-size:12px;padding:16px}
video,canvas,img{width:100%;border-radius:12px}
</style>

<!-- CHART -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <h2>Graha Mega Solusindo</h2>
  <div class="small">Sistem Presensi Digital</div>
</header>

<div id="app"></div>

<footer>supported by Klase Auto Graha Â· rionurmansyah</footer>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxxfXTuZD-E24yf7xN-YbkmhGXZhRg3UC2zMThMjUuylSGIJ_riTfwqRzTUA-azhoZ8/exec";

/* ================= STATE ================= */
let USER=null, LOC=null, PHOTO=null, MODE=null;

/* ================= UTIL ================= */
function el(id){return document.getElementById(id)}
function api(action,data={}){
  const qs=new URLSearchParams({action,...data}).toString();
  return fetch(API_URL+"?"+qs).then(r=>r.json());
}
function post(action,data){
  return fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action,...data})
  }).then(r=>r.json());
}

/* ================= GPS ================= */
function getGPS(){
  return new Promise((ok,err)=>{
    navigator.geolocation.getCurrentPosition(
      p=>ok({lat:p.coords.latitude,lng:p.coords.longitude}),
      e=>err(e.message),
      {enableHighAccuracy:true}
    );
  });
}

/* ================= LOGIN ================= */
function showLogin(){
  el('app').innerHTML=`
  <div class="card">
    <h3>Login</h3>
    <input id="id" placeholder="ID Karyawan">
    <input id="name" placeholder="Nama Lengkap">
    <button class="btn primary" onclick="login()">Masuk</button>
    <div id="msg"></div>
  </div>`;
}
async function login(){
  const r=await api('login',{id:el('id').value,name:el('name').value});
  if(!r.success)return el('msg').innerText=r.message;
  USER=r.user;
  showDashboard();
}

/* ================= DASHBOARD ================= */
async function showDashboard(){
  const a=await api('checkAttendance',{id:USER.id});
  el('app').innerHTML=`
  <div class="card">
    <h3>ðŸ‘¤ ${USER.name}</h3>
    <div class="small">ID: ${USER.id} Â· ${USER.location}</div>
  </div>

  <div class="card">
    <button class="btn success" onclick="openCam('clockIn')" ${a.clockIn?'disabled':''}>Clock In</button>
    <button class="btn danger" onclick="openCam('clockOut')" ${!a.clockIn||a.clockOut?'disabled':''}>Clock Out</button>
  </div>

  <div class="card">
    <button class="btn secondary" onclick="showHistory()">Riwayat</button>
    <button class="btn secondary" onclick="showPengajuan()">Pengajuan</button>
    ${USER.role==='Admin'?'<button class="btn primary" onclick="showAdmin()">Admin</button>':''}
    <button class="btn" onclick="showLogin()">Keluar</button>
  </div>`;
}

/* ================= CAMERA ================= */
async function openCam(mode){
  MODE=mode;
  LOC=await getGPS();
  el('app').innerHTML=`
  <div class="card">
    <h3>${mode==='clockIn'?'Clock In':'Clock Out'}</h3>
    <video id="v" autoplay playsinline></video>
    <button class="btn primary" onclick="shot()">Ambil Foto</button>
  </div>`;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}})
    .then(s=>el('v').srcObject=s);
}
function shot(){
  const v=el('v');
  const c=document.createElement('canvas');
  c.width=v.videoWidth;c.height=v.videoHeight;
  c.getContext('2d').drawImage(v,0,0);
  PHOTO=c.toDataURL('image/jpeg');
  sendAbsensi();
}
async function sendAbsensi(){
  const r=await api(MODE,{
    id:USER.id,name:USER.name,
    latitude:LOC.lat,longitude:LOC.lng
  });
  if(!r.success)return alert(r.message);
  await post('uploadFoto',{id:USER.id,mode:MODE,photo:PHOTO});
  showDashboard();
}

/* ================= HISTORY ================= */
async function showHistory(){
  const r=await api('getUserHistory',{id:USER.id});
  el('app').innerHTML='<div class="card"><h3>Riwayat</h3>'+
    r.data.map(d=>${d.tanggal} ${d.jamMasuk}-${d.jamPulang}).join('<br>')+
    '<br><button class="btn" onclick="showDashboard()">Kembali</button></div>';
}

/* ================= PENGAJUAN ================= */
function showPengajuan(){
  el('app').innerHTML=`
  <div class="card">
    <h3>Pengajuan</h3>
    <select id="j"><option>Izin</option><option>Cuti</option></select>
    <input id="t" type="date">
    <textarea id="a" maxlength="100"></textarea>
    <button class="btn primary" onclick="kirimPengajuan()">Kirim</button>
    <button class="btn" onclick="showDashboard()">Kembali</button>
  </div>`;
}
async function kirimPengajuan(){
  const r=await api('createPengajuan',{
    id:USER.id,name:USER.name,
    jenis:el('j').value,tanggal:el('t').value,alasan:el('a').value
  });
  alert(r.message);showDashboard();
}

/* ================= ADMIN ================= */
async function showAdmin(){
  const r=await api('getAttendanceReportAdvanced');
  el('app').innerHTML=`
  <div class="card">
    <h3>Admin</h3>
    <canvas id="g"></canvas>
    <button class="btn primary" onclick="exportCSV()">Export CSV</button>
    <button class="btn" onclick="showDashboard()">Kembali</button>
  </div>`;
  new Chart(el('g'),{
    type:'bar',
    data:{labels:r.data.map(x=>x[0]),
    datasets:[{label:'Hadir',data:r.data.map(()=>1)}]}
  });
}
function exportCSV(){
  api('exportCSV').then(r=>{
    const b=new Blob([r.csv],{type:'text/csv'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);a.download=r.filename;a.click();
  });
}

/* ================= INIT ================= */
showLogin();
</script>
</body>
</html>
