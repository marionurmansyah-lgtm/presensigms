<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presensi GMS</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f4f6fb;
  min-height:100vh;
  padding:16px;
}
.card{
  max-width:430px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}
.hidden{display:none}
h2{text-align:center;margin-bottom:12px}
input,select,textarea{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
textarea{resize:vertical;min-height:80px}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}
.btn-primary{background:#2a5298;color:#fff}
.btn-success{background:#1abc9c;color:#fff}
.btn-danger{background:#e74c3c;color:#fff;margin-top:8px}
.footer{
  text-align:center;
  font-size:11px;
  color:#777;
  margin-top:14px;
}
.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:11px;
  background:#eef;
}
.notice{
  background:#e8f4ff;
  padding:10px;
  border-radius:8px;
  font-size:13px;
  margin-bottom:10px;
}
  button {
  position: relative;
  z-index: 10;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginPage" class="card">
  <h2>Presensi GMS</h2>
  <p style="text-align:center;font-size:13px;margin-bottom:12px">
    Sistem Presensi Digital
  </p>

  <input id="loginNama" placeholder="Nama Lengkap">
  <input id="loginId" placeholder="ID Karyawan">

  <button class="btn-primary" onclick="login()">
    <i class="fa-solid fa-right-to-bracket"></i> Login
  </button>

  <div class="footer">
    Supported by: <b>Klase Auto Graha</b><br>
    Rio Nurmansyah
  </div>
</div>

<!-- ================= USER DASHBOARD ================= -->
<div id="userDashboard" class="card hidden">
  <h2>Dashboard</h2>

  <div class="notice">
    <b id="uNama"></b><br>
    ID: <span id="uId"></span><br>
    Lokasi Kerja: <span id="uLokasi"></span>
  </div>

  <button class="btn-success" onclick="clockIn()">
    <i class="fa-solid fa-clock"></i> Clock In
  </button>

  <button class="btn-danger" onclick="clockOut()">
    <i class="fa-solid fa-clock"></i> Clock Out
  </button>

  <hr style="margin:14px 0">

  <h3>Pengajuan</h3>
  <select id="pjJenis">
    <option value="">Pilih Jenis</option>
    <option value="Izin">Izin</option>
    <option value="Sakit">Sakit</option>
    <option value="Cuti">Cuti</option>
  </select>
  <textarea id="pjAlasan" placeholder="Alasan pengajuan"></textarea>
  <button class="btn-primary" onclick="kirimPengajuan()">
    Kirim Pengajuan
  </button>

  <button class="btn-danger" onclick="logout()">
  <i class="fa-solid fa-right-from-bracket"></i> Logout
</button>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzrS_SSkeStNLrdppule2LxSCZGOyby9L4ekAfzHUdERbRBFqd82hGkI6_h3BpxI-M4YA/exec";

/* ================= STATE ================= */
let currentUser = null;

/* ================= LOGIN ================= */
async function login(){
  const nama = loginNama.value.trim();
  const id   = loginId.value.trim();
  if(!nama || !id){ alert("Lengkapi data"); return; }

  const res = await fetch(
    ${API_URL}?action=login&id=${encodeURIComponent(id)}&nama=${encodeURIComponent(nama)}
  );
  const json = await res.json();
  if(!json.success){ alert(json.message); return; }

  currentUser = json.data;
  localStorage.setItem("user",JSON.stringify(currentUser));

  loginPage.classList.add("hidden");
  userDashboard.classList.remove("hidden");

  uNama.innerText = currentUser.nama;
  uId.innerText   = currentUser.id;
  uLokasi.innerText = currentUser.lokasiKerja || "-";
}

/* ================= GPS HELPER ================= */
function withGPS(callback){
  navigator.geolocation.getCurrentPosition(
    pos => callback(pos.coords.latitude,pos.coords.longitude),
    () => alert("GPS tidak aktif / ditolak")
  );
}

/* ================= CLOCK IN ================= */
function clockIn(){
  withGPS((lat,lng)=>{
    fetch(${API_URL}?action=clockIn&id=${currentUser.id}&lat=${lat}&lng=${lng})
    .then(r=>r.json()).then(j=>alert(j.message));
  });
}

/* ================= CLOCK OUT ================= */
function clockOut(){
  withGPS((lat,lng)=>{
    fetch(${API_URL}?action=clockOut&id=${currentUser.id}&lat=${lat}&lng=${lng})
    .then(r=>r.json()).then(j=>alert(j.message));
  });
}

/* ================= PENGAJUAN ================= */
function kirimPengajuan(){
  const jenis = pjJenis.value;
  const alasan = pjAlasan.value.trim();
  if(!jenis || !alasan){ alert("Lengkapi pengajuan"); return; }

  fetch(${API_URL}?action=pengajuan&id=${currentUser.id}&nama=${currentUser.nama}&jenis=${jenis}&alasan=${encodeURIComponent(alasan)})
  .then(r=>r.json()).then(j=>{
    alert("Pengajuan dikirim. Mohon tunggu approval.");
    pjJenis.value=""; pjAlasan.value="";
  });
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.clear();
  location.reload();
}

/* ================= AUTO LOGIN ================= */
const saved = localStorage.getItem("user");
if(saved){
  currentUser = JSON.parse(saved);
  loginPage.classList.add("hidden");
  userDashboard.classList.remove("hidden");
  uNama.innerText=currentUser.nama;
  uId.innerText=currentUser.id;
  uLokasi.innerText=currentUser.lokasiKerja||"-";
}
</script>

</body>
</html>

