<!DOCTYPE html>
<html lang="id">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi GMS - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS STYLE --- */
    :root {
        --primary: #1e293b; 
        --primary-hover: #0f172a;
        --primary-light: #334155;
        --accent: #3b82f6; 
        --success: #10b981;
        --success-light: #d1fae5;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --warning: #f59e0b;
        
        --bg-app: #f1f5f9; 
        --bg-pattern: radial-gradient(#cbd5e1 1px, transparent 1px);
        --surface: #ffffff;
        
        --text-main: #0f172a;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        
        --border: #e2e8f0;
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
        background-color: var(--bg-app); 
        background-image: var(--bg-pattern);
        background-size: 20px 20px;
        color: var(--text-main); 
        font-family: 'Inter', sans-serif; 
        padding-bottom: 100px; 
        -webkit-font-smoothing: antialiased;
    }
    
    .hidden { display: none !important; }
    
    .container { max-width: 480px; margin: 0 auto; padding: 0 20px; width: 100%; }
    .container.admin { max-width: 1200px; }

    .card { 
        background: var(--surface); 
        border-radius: var(--radius-md); 
        padding: 24px; 
        box-shadow: var(--shadow-sm); 
        margin-bottom: 24px; 
        border: 1px solid var(--border); 
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    /* BUTTONS WITH SPINNER */
    .btn { 
        padding: 14px 24px; 
        border: none; 
        border-radius: 12px; 
        font-weight: 600; 
        font-size: 0.95rem; 
        letter-spacing: 0.025em; 
        cursor: pointer; 
        width: 100%; 
        transition: all 0.2s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.7; cursor: wait; }
    
    .btn-primary { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.25); 
    }
    
    .btn-success { 
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); 
    }
    
    .btn-danger { 
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); 
    }
    
    .btn-outline { 
        background: white; 
        border: 1px solid var(--border); 
        color: var(--text-main); 
        box-shadow: none; 
    }
    .btn-outline:hover { background: #f1f5f9; }
    
    .btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; display: inline-flex; height: 36px; }
    .btn-print { background: var(--text-main); color: white; width: auto; box-shadow: none; }
    .btn-excel { background: #217346; color: white; width: auto; box-shadow: none; }

    /* SPINNER ANIMATION */
    .spinner {
        width: 16px; height: 16px;
        border: 2px solid #ffffff;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* INPUTS */
    input, select, textarea { 
        width: 100%; 
        padding: 14px 16px; 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        margin-bottom: 16px; 
        font-size: 0.95rem; 
        background: #fdfdfd;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
    }
    
    input:focus, select:focus, textarea:focus { 
        border-color: var(--accent); 
        outline: none; 
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
        background: #fff;
    }
    
    label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px; letter-spacing: 0.025em; }

    /* LOGIN */
    .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; }
    .login-card { 
        width: 100%; 
        max-width: 400px; 
        text-align: center; 
        background: white; 
        padding: 40px 30px; 
        border-radius: 32px; 
        box-shadow: var(--shadow-lg); 
        border: 1px solid var(--border);
    }
    .app-logo { 
        width: 80px; height: 80px; margin: 0 auto 24px; display: block; object-fit: contain; 
        border-radius: 20px; box-shadow: var(--shadow-md);
    }
    .login-footer { margin-top: 30px; text-align: center; color: var(--text-light); font-size: 0.85rem; }
    .brand-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 4px; color: var(--primary); }
    .support-text { font-weight: 500; }

    /* PROFILE & CLOCK */
    .profile-header { 
        background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%); 
        color: white; 
        padding: 50px 24px 80px; 
        border-radius: 0 0 40px 40px; 
        margin-top: -20px; 
        box-shadow: var(--shadow-md);
        position: relative;
    }
    .profile-content { display: flex; align-items: center; gap: 16px; }
    .profile-avatar-icon { 
        width: 60px; height: 60px; border-radius: 50%; 
        background: rgba(255,255,255,0.25); 
        display: flex; align-items: center; justify-content: center; 
        border: 2px solid rgba(255,255,255,0.6);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .clock-widget { 
        background: var(--glass-bg); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        margin-top: -50px; 
        margin-bottom: 30px; 
        padding: 24px; 
        border-radius: 24px; 
        text-align: center; 
        box-shadow: var(--shadow-lg); 
        position: relative; 
        z-index: 10;
        border: 1px solid var(--glass-border);
    }
    #date-display { font-size: 0.75rem; font-weight: 600; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1.5px; }
    #time-display { font-size: 3rem; font-weight: 800; color: var(--primary); line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -2px; }

    /* CLOCK BUTTONS */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 30px; }
    .clock-btn { height: 120px; flex-direction: column; font-size: 1.1rem; font-weight: 700; border-radius: 24px; border: none; }
    
    /* MARQUEE */
    .marquee-strip {
        background: #fffbeb; color: #92400e; padding: 14px 0; border-radius: 12px; margin: 16px 0;
        font-size: 0.9rem; font-weight: 600; overflow: hidden; white-space: nowrap;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #fcd34d;
    }
    .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
     
    /* ADMIN */
    .container.admin { max-width: 95%; margin: 30px auto; padding: 0; width: 100%; }

    /* TABS */
    .tab-btn { 
        background: white; border: 1px solid var(--border); color: var(--text-muted); 
        padding: 12px 28px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; 
        white-space: nowrap; cursor: pointer; transition: all 0.2s;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); border-color: var(--primary); }
    .tab-btn.active {
        background: var(--primary) !important; color: white !important; border-color: var(--primary) !important;
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.3); font-weight: 700; transform: translateY(-2px);
    }
    .tab-emp.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; border-color: #059669 !important; }
    .tab-att.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; border-color: #2563eb !important; }
    .tab-sub.active { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; border-color: #d97706 !important; }
    
    /* TABLES */
    .table-container { overflow-x: auto; background: white; border-radius: var(--radius-md); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f8fafc; text-align: left; padding: 16px 20px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
    tr:hover td { background: #fdfdfd; }

    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-success { background: var(--success-light); color: #065f46; }
    .badge-danger { background: var(--danger-light); color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    .admin-header { display: flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom: 1px solid var(--border); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow-sm); }
    .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; line-height: 1; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; }

    .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .filter-bar input, .filter-bar select { width: auto; min-width: 140px; margin-bottom: 0; font-size: 0.85rem; padding: 8px 12px; }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-box { background: white; width: 95%; max-width: 500px; border-radius: 24px; padding: 32px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* TOAST */
    #toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast { background: white; padding: 16px 24px; border-radius: 12px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; min-width: 300px; border-left: 5px solid var(--primary); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; font-size: 0.9rem; font-weight: 500; }
    .toast.show { transform: translateX(0); }
    .toast.error { border-left-color: var(--danger); }

    video { width: 100%; height: 280px; background: black; border-radius: 20px; object-fit: cover; transform: scaleX(-1); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .input-group { display: flex; gap: 10px; }
    .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #f1f5f9; font-weight: 600; color: var(--text-main); font-size: 1.05rem; }
    .accordion-body { padding: 20px 0; background: transparent; }
    .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; cursor: pointer; border: 1px solid var(--border); }

    /* PRINT */
    @media print {
        body * { visibility: hidden; }
        .print-area, .print-area * { visibility: visible; }
        .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; }
        .no-print { display: none !important; }
    }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- VIEW: LOGIN -->
    <section id="view-login" class="container">
        <div class="login-wrapper">
            <div class="login-card">
                <img src="https://i.imgur.com/xX4QN18.png" alt="Logo Perusahaan" class="app-logo">
                <h2 style="margin-bottom: 8px; color: var(--primary);">Sistem Presensi GMS</h2>
                <p style="color: var(--text-muted); margin-bottom: 32px; font-size: 0.95rem;">Selamat Datang</p>
                
                <label>Nama Lengkap</label>
                <input type="text" id="login-name" placeholder="Cth: Budi" autocomplete="off">
                
                <label style="margin-top:16px;">ID Pengguna</label>
                <div style="position: relative;">
                    <input type="password" id="login-id" placeholder="Cth: 001" style="padding-right: 45px;" autocomplete="off">
                    <div onclick="app.togglePassword()" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);">
                        <svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8-11 8-11-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="eye-off-icon" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8-11-8a18.45 18.45 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </div>
                </div>

               <button type="button" id="btn-login" class="btn btn-primary" style="margin-top:24px; width:100%;">Masuk Aplikasi</button>
                
                <div style="margin-top:20px; font-size:0.75rem; color:#999; background:#f1f5f9; padding:10px; border-radius:12px;">
                    <b>Info Demo (Supabase DB):</b><br>
                    Admin: ID <b>klase123#</b>, Pass <b>admin</b><br>
                    Karyawan: ID <b>001</b>, Pass <b>andi</b>
                </div>
            </div>
            
            <!-- FOOTER SESUAI REQUEST -->
            <div class="login-footer">
                <p class="brand-name">Graha Mega Solusindo</p>
                <p class="support-text">supported by : Klase Auto Graha</p>
            </div>
        </div>
    </section>

    <!-- VIEW: EMPLOYEE -->
    <section id="view-employee" class="container hidden">
        <div class="profile-header">
            <div class="profile-content">
                <div class="profile-avatar-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4-4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div>
                    <h2 id="emp-name" style="font-weight:700; font-size: 1.2rem;">Nama User</h2>
                    <small id="emp-role" style="opacity:0.9; font-size: 0.9rem;">Karyawan</small>
                </div>
            </div>
        </div>
        
        <div class="clock-widget">
            <div id="date-display">Senin, 1 Januari 2024</div>
            <div id="time-display">00:00:00</div>
        </div>

        <div class="card" style="margin-top:-15px; padding:12px 20px; display:flex; align-items:center; gap:12px;">
            <div id="gps-dot" style="width:12px; height:12px; background:#ccc; border-radius:50%;"></div>
            <div style="flex:1;">
                <div id="gps-status-text" style="font-size:0.9rem; font-weight:700;">Mencari Lokasi...</div>
                <div id="gps-coords" style="font-size:0.75rem; color:var(--text-muted);">Lat: -, Lng: -</div>
            </div>
        </div>

        <div id="gps-rule-info" class="hidden" style="background:#e0e7ff; color:#3730a3; padding:14px 20px; border-radius:12px; margin-bottom:20px; font-size:0.85rem; border:1px solid #c7d2fe;">
            ‚ÑπÔ∏è Anda harus berada di radius <span id="rule-radius">0</span>m dari <span id="rule-loc">Lokasi</span>
        </div>

        <div class="marquee-strip">
            <div class="marquee-content">
                ‚ö†Ô∏è Jangan Lupa Presensi / Gunakan fitur pengajuan jika tidak masuk kerja Atau Lupa absen &nbsp;&nbsp;&nbsp; ‚ö†Ô∏è Waktu Presensi Terbatas
            </div>
        </div>

        <div class="clock-grid">
            <button onclick="app.openCamera('Masuk')" class="btn btn-success clock-btn"><span style="font-size:1.6rem;">üì•</span>Clock In</button>
            <button onclick="app.openCamera('Pulang')" class="btn btn-danger clock-btn"><span style="font-size:1.6rem;">üì§</span>Clock Out</button>
        </div>

        <!-- FORM PENGAJUAN -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-form').classList.toggle('hidden')">
                <span style="font-weight:700;">üìÑ Ajukan Izin / Sakit</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-form" class="hidden accordion-body">
                <label>Jenis Pengajuan</label>
                <select id="sub-type">
                    <option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Cuti">Cuti</option><option value="Lupa Absen">Lupa Absen</option>
                </select>
                <label>Tanggal Pengajuan</label>
                <input type="date" id="sub-date">
                <label>Keterangan (Max 100 Karakter)</label>
                <textarea id="sub-desc" style="font-size:0.95rem; min-height:80px;" placeholder="Tulis keterangan..."></textarea>
                <small id="char-count" style="display:block; margin-bottom:15px; font-size:0.75rem; color:var(--text-muted); text-align:right;">0/100 Karakter</small>
                <label>Upload Bukti (Foto)</label>
                <input type="file" id="sub-proof" accept="image/*">
                <button id="btn-submit-sub" onclick="app.submitPengajuan()" class="btn btn-primary" style="margin-top:15px;">Kirim Pengajuan</button>
            </div>
        </div>

        <!-- RIWAYAT -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-history').classList.toggle('hidden')">
                <span style="font-weight:700;">üìë Riwayat Pengajuan</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-history" class="accordion-body">
                <div id="history-list-sub">
                    <div style="text-align:center; padding:20px; color:#999;">Memuat riwayat...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:15px;">Riwayat Absen</h3>
            <div id="history-list-absen" style="margin-top:10px;">
                <div style="text-align:center; padding:10px; color:#999;">Belum ada data hari ini.</div>
            </div>
        </div>
        <button onclick="app.logout()" class="btn btn-outline">Keluar</button>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="container admin hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;" class="no-print">
            <h2>Admin Dashboard</h2>
            <button onclick="app.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap;" class="no-print">
            <button onclick="app.switchTab('employees', this)" class="tab-btn tab-emp active">Data Karyawan</button>
            <button onclick="app.switchTab('attendance', this)" class="tab-btn tab-att">Rekap Absen</button>
            <button onclick="app.switchTab('submissions', this)" class="tab-btn tab-sub">Pengajuan</button>
            <button onclick="app.refreshData()" class="btn btn-primary btn-sm" style="width:auto;">üîÑ Refresh</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Karyawan</div>
                <div class="stat-val" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--success);">Hadir Hari Ini</div>
                <div class="stat-val" id="stat-present" style="color:var(--success);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--danger);">Belum Hadir</div>
                <div class="stat-val" id="stat-absent" style="color:var(--danger);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--warning);">Pengajuan Pending</div>
                <div class="stat-val" id="stat-sub" style="color:var(--warning);">0</div>
            </div>
        </div>

        <!-- Tab Employees -->
        <div id="tab-employees" class="print-area">
            <div class="card" style="padding: 0; overflow:hidden;">
                <div class="filter-bar no-print">
                    <input id="filter-emp-id" placeholder="Cari ID..." onkeyup="app.filterTable('admin-emp-table', 0, this.value)">
                    <input id="filter-emp-name" placeholder="Cari Nama..." onkeyup="app.filterTable('admin-emp-table', 1, this.value)">
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>
                <div style="padding:20px; background:#f8fafc; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center;" class="no-print">
                    <button onclick="app.showAddUserModal()" class="btn btn-primary btn-sm">+ Tambah Manual</button>
                    <button onclick="document.getElementById('import-csv').click()" class="btn btn-success btn-sm">üìÇ Import CSV</button>
                    <input type="file" id="import-csv" accept=".csv" style="display:none" onchange="app.handleImport(this)">
                    <small style="font-size:0.7rem; color:#888;">Format: ID,Nama,Role,Lokasi,GPS,Lat,Lng,Radius</small>
                </div>
                <div class="table-container">
                    <table id="admin-emp-table">
                        <thead><tr><th>ID</th><th>Nama</th><th>Role</th><th>Lokasi</th><th>Mode GPS</th><th>Lat, Lng</th><th>Radius</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Attendance -->
        <div id="tab-attendance" class="print-area hidden">
            <div class="card" style="padding: 0; overflow:hidden;">
                 <div class="filter-bar no-print">
                    <input type="month" id="filter-att-month" placeholder="Filter Bulan" onchange="app.renderAttendanceTable()">
                    <input id="filter-att-name" placeholder="Cari Nama..." onkeyup="app.renderAttendanceTable()">
                    <button onclick="app.exportToExcel()" class="btn btn-excel btn-sm">üìä Download Excel</button>
                    <button onclick="window.print()" class="btn btn-print btn-sm">  Print </button>
                </div>
                <div class="table-container">
                    <table id="admin-att-table">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Tipe</th><th>Lokasi (Lat, Lng)</th><th>Foto</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Submissions -->
        <div id="tab-submissions" class="print-area hidden">
            <div class="card" style="padding: 0; overflow:hidden;">
                <div class="filter-bar no-print">
                    <select id="filter-sub-status" onchange="app.renderSubmissionTable()">
                        <option value="">Semua Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>
                <div class="table-container">
                    <table id="admin-sub-table">
                        <thead><tr><th>Tgl</th><th>Nama</th><th>Tipe</th><th>Keterangan</th><th>Bukti</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALS -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="user-modal-title" style="margin-bottom:20px; font-weight:700;">Tambah Karyawan</h3>
            <input type="hidden" id="old-id">
            <label>ID Karyawan</label><input type="text" id="new-id">
            <label>Nama Lengkap</label><input type="text" id="new-name">
            <label>Password (Login)</label><input type="text" id="new-pass" placeholder="Isi password">
            <label>Role</label>
            <select id="new-role"><option value="employee">Employee</option><option value="admin">Admin</option></select>
            
            <div style="margin:20px 0; border-top:1px solid #eee; padding-top:20px;">
                <label style="color:var(--primary);">Pengaturan Lokasi & GPS</label>
                <label>Nama Lokasi</label><input type="text" id="new-workloc">
                <label>Mode GPS</label>
                <select id="new-gpsmode" onchange="app.toggleGpsInputs()">
                    <option value="bebas">Bebas</option>
                    <option value="terkunci">Terkunci</option>
                </select>
                <div id="gps-inputs" class="hidden">
                    <label>Lat / Lng</label>
                    <div class="input-group">
                        <input type="text" id="new-lat" placeholder="Latitude">
                        <input type="text" id="new-lng" placeholder="Longitude">
                    </div>
                    <button onclick="app.getCurrentLocForAdmin()" class="btn btn-outline btn-sm" style="margin-bottom:10px; width:100%;">üìç Pakai Lokasi Saya</button>
                    <label>Radius (meter)</label><input type="number" id="new-radius" value="100">
                </div>
            </div>
            <div class="input-group">
                <button onclick="document.getElementById('user-modal').style.display='none';" class="btn btn-outline">Batal</button>
                <button id="btn-save-user" onclick="app.saveNewUser()" class="btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h3 id="cam-action" style="margin-bottom:15px;">Clock In</h3>
            <video id="webcam" autoplay playsinline></video>
            <div class="input-group" style="margin-top:20px;">
                <button onclick="app.closeCamera()" class="btn btn-outline">Batal</button>
                <button onclick="app.takePhoto()" class="btn btn-primary">Ambil & Kirim</button>
            </div>
        </div>
    </div>

  <!-- JAVASCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
/* ============================================================
   1. KONFIGURASI & GLOBAL UTILITY
   ============================================================ */
const SUPABASE_URL = 'https://sjvjmwxugpnqguqtbtnt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqdmptd3h1Z3BucWd1cXRidG50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDA0MTAsImV4cCI6MjA4NTI3NjQxMH0.Z54oBK-aS4EXwVt3ZO1cRaI5GKfRLXrgsU4TLdICvj4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);

// Fungsi pengamanan password
async function hashPassword(str) {
    const utf8 = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

// Fungsi upload gambar ke Storage
async function uploadFile(blob, folder) {
    const fileName = `${folder}/${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
    const { data, error } = await supabase.storage.from('gms_uploads').upload(fileName, blob);
    if (error) throw error;
    return supabase.storage.from('gms_uploads').getPublicUrl(fileName).data.publicUrl;
}

/* ============================================================
   2. LOGIKA UTAMA APLIKASI (app)
   ============================================================ */
const app = {
    data: { currentUser: null, loc: { lat: 0, lng: 0 }, settings: {} },

    async init() {
        // Load settings (Nomor WA Admin)
        const { data: set } = await supabase.from('settings').select('*');
        this.data.settings = set ? set.reduce((a, v) => ({ ...a, [v.key]: v.value }), {}) : { admin_wa: '62811811451' };
        
        // Cek sesi login
        const saved = sessionStorage.getItem('gms_user');
        if (saved) { 
            this.data.currentUser = JSON.parse(saved); 
            this.route(); 
        }
        
        setInterval(() => this.updateClock(), 1000);
    },

    updateClock() {
        const n = new Date();
        if ($('time-display')) {
            $('date-display').textContent = n.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            $('time-display').textContent = n.toLocaleTimeString('id-ID');
        }
    },

    // --- FITUR ANTI-DUPLIKAT ---
    async isDuplicate(type) {
        const today = new Date().toISOString().split('T')[0];
        const { data } = await supabase.from('attendance')
            .select('id')
            .eq('user_id', this.data.currentUser.id_user)
            .eq('type', type)
            .gte('timestamp', `${today}T00:00:00Z`)
            .lte('timestamp', `${today}T23:59:59Z`);
        return data && data.length > 0;
    },

    // --- SISTEM LOGIN ---
    async login() {
        const id = $('login-id').value;
        const nameInput = $('login-name').value.toLowerCase();
        const pass = prompt("Masukkan Password:");
        if (!pass) return;

        const { data: user, error } = await supabase.from('users').select('*').eq('id_user', id).single();

        if (user && user.name.toLowerCase() === nameInput) {
            const hashed = await hashPassword(pass);
            if (hashed === user.password_hash) {
                this.data.currentUser = user;
                sessionStorage.setItem('gms_user', JSON.stringify(user));
                this.route();
            } else { alert("Password Salah!"); }
        } else { alert("Data tidak ditemukan atau ID salah."); }
    },

    route() {
        $('view-login').classList.add('hidden');
        const role = this.data.currentUser.role.toLowerCase();
        if (role === 'admin') {
            $('view-admin').classList.remove('hidden');
            this.refreshAdmin();
        } else {
            $('view-employee').classList.remove('hidden');
            $('emp-name').textContent = this.data.currentUser.name;
            this.getLocation();
            this.renderUserHistory();
        }
    },

    // --- ABSENSI & KAMERA ---
    async openCamera(type) {
        if (await this.isDuplicate(type)) return alert(`Anda sudah melakukan Clock ${type} hari ini!`);
        
        this.currentAction = type;
        $('camera-modal').style.display = 'flex';
        try {
            this.data.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            $('webcam').srcObject = this.data.stream;
        } catch (e) { alert("Kamera gagal dibuka: " + e.message); }
    },

    closeCamera() {
        if (this.data.stream) this.data.stream.getTracks().forEach(t => t.stop());
        $('camera-modal').style.display = 'none';
    },

    async takePhoto() {
        const video = $('webcam');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; 
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob(async (blob) => {
            try {
                alert("Sedang mengunggah...");
                const photoUrl = await uploadFile(blob, 'attendance');
                await supabase.from('attendance').insert([{
                    user_id: this.data.currentUser.id_user,
                    name: this.data.currentUser.name,
                    type: this.currentAction,
                    lat: this.data.loc.lat,
                    lng: this.data.loc.lng,
                    photo_url: photoUrl
                }]);
                alert('Absensi Berhasil!');
                this.closeCamera();
                this.renderUserHistory();
            } catch (e) { alert("Error: " + e.message); }
        }, 'image/jpeg');
    },

    // --- PENGAJUAN (IZIN/SAKIT) ---
    async submitPengajuan() {
        const file = $('sub-proof').files[0];
        const date = $('sub-date').value;
        const desc = $('sub-desc').value;
        if (!file || !date) return alert("Tanggal dan Bukti Foto wajib diisi!");

        try {
            const url = await uploadFile(file, 'submissions');
            const payload = {
                user_id: this.data.currentUser.id_user,
                name: this.data.currentUser.name,
                type: $('sub-type').value,
                date: date,
                description: desc,
                proof_url: url,
                status: 'Pending'
            };
            await supabase.from('submissions').insert([payload]);

            // Kirim WA Otomatis
            const msg = `*PENGAJUAN GMS*%0ANama: ${payload.name}%0ATipe: ${payload.type}%0ATanggal: ${payload.date}%0ABukti: ${url}`;
            window.open(`https://wa.me/${this.data.settings.admin_wa}?text=${msg}`, '_blank');
            
            alert("Pengajuan Berhasil Terkirim!");
            this.renderUserHistory();
        } catch (e) { alert(e.message); }
    },

    // --- ADMIN: IMPORT CSV (SESUAI FILE ANDA) ---
    async handleImport(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split('\n');
            let successCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const col = lines[i].split(',');
                if (col[0] && col[1]) {
                    const rawPass = col[6] ? col[6].trim() : 'user123';
                    const hashedPass = await hashPassword(rawPass);
                    
                    await supabase.from('users').upsert({
                        id_user: col[0].trim(),
                        name: col[1].trim(),
                        work_location: col[3] ? col[3].trim() : '',
                        role: col[5] ? col[5].trim() : 'User',
                        password_hash: hashedPass,
                        gps_mode: col[7] ? col[7].trim() : 'bebas'
                    });
                    successCount++;
                }
            }
            alert(`Berhasil mengimpor ${successCount} data karyawan.`);
            this.refreshAdmin();
        };
        reader.readAsText(file);
    },

    async refreshAdmin() {
        const { data: users } = await supabase.from('users').select('*');
        const { data: att } = await supabase.from('attendance').select('*').order('timestamp', {ascending: false});
        const { data: sub } = await supabase.from('submissions').select('*').order('created_at', {ascending: false});

        // Update Statistik Admin
        if($('stat-total')) $('stat-total').textContent = users.length;
        if($('stat-present')) $('stat-present').textContent = att.filter(x => new Date(x.timestamp).toDateString() === new Date().toDateString()).length;
        if($('stat-sub-pending')) $('stat-sub-pending').textContent = sub.filter(x => x.status === 'Pending').length;

        // Panggil fungsi render tabel admin Anda di sini
        // this.renderAdminTables(users, att, sub); 
    },

    getLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            this.data.loc = { lat: p.coords.latitude, lng: p.coords.longitude };
        }, err => console.error("GPS Error:", err));
    },

    logout() {
        sessionStorage.clear();
        location.reload();
    }
};

// Jalankan aplikasi
document.addEventListener('DOMContentLoaded', () => app.init());
 // Menghubungkan tombol dengan fungsi login
document.getElementById('btn-login').addEventListener('click', function() {
    // Pastikan nama fungsi di bawah ini sesuai dengan nama fungsi login 
    // yang kamu punya (biasanya bernama loginUser atau handleLogin)
    if (typeof loginUser === "function") {
        loginUser();
    } else {
        alert("Fungsi login tidak ditemukan di dalam script!");
    }
});             
</script>
</body>
</html>

